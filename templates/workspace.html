{% extends "base.html" %}
{% block title %}Workspace{% endblock %}

{% block stylesheets %}
<link rel="stylesheet" href="../static/Styles/workspace.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
{% endblock %}
{% block scripts %}
{% endblock %}

{% block content %}
<header>
    <nav id="Navbar">
        <a href="./" class="NavLink Logo" id="HomePage"><img src="../static/Images/Logo.png" alt="Logo"
                class="Logo"></a>
            <div id="LinkContainer">
                <a href="/profile/{{ username }}" class="NavLink" id="ProfileTab">Profile</a>
                <a href="./upload" class="NavLink">Upload</a>
                {% if isAdmin == "True"%}
                <div id="AdminTab">
                    <a href="./adminPage" class="NavLink">Admin hub</a>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </nav>
</header>

<div class="MainBody">
    <div class="Heading">The Workspace</div>

    <h1 style="width:100%">Previously uploaded images:</h1>

    <div id="imageContainer">

    </div>
    <button id="imageClear">Clear</button>
    <script>
        var imageContainer = document.getElementById("imageContainer");
        function emptyImages() {
            fetch('/empty-selected', {
                method: 'POST'
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('Failed to remove all images from selection.');
                    }
                })
                .then(data => {
                    console.log(data.message);
                })
                .catch(error => {
                    console.error('Error:', error.message);
                });
        }

        function toggleImage(image, selectButton) {
            fetch('/toggle-image', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ image: image })
            })
                .then(response => {
                    if (response.ok) {
                        response.json().then(data => {
                            if (data.selected) {
                                selectButton.classList.remove('bi-check-circle');
                                selectButton.classList.add('bi-check-circle-fill');
                            } else {
                                selectButton.classList.remove('bi-check-circle-fill');
                                selectButton.classList.add('bi-check-circle');
                            }
                        });
                    } else {
                        console.error('Failed to toggle selected status for image.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function loadImages(imageSet) {
            while (imageContainer.firstChild) {
                imageContainer.removeChild(imageContainer.firstChild);
            }
            imageSet.forEach(function (imageSet) {
                var img = document.createElement("img");
                img.src = "data:image/jpeg;base64," + imageSet.data;
                img.alt = imageSet.name;

                var div = document.createElement("div");
                div.classList.add("image-item");

                var selectButton = document.createElement("i");
                selectButton.classList.add("bi", "bi-check-circle", "close-button");

                selectButton.addEventListener('click', function () {
                    toggleImage(imageSet, selectButton);
                });

                var label = document.createElement('label');
                label.textContent = imageSet.name;

                div.appendChild(img);
                div.appendChild(selectButton);
                div.appendChild(label);
                imageContainer.appendChild(div);
            });
        }

        var clear = document.getElementById("imageClear");
        clear.addEventListener('click', function () {
            emptyImages();
            var checks = imageContainer.querySelectorAll('.bi.close-button.bi-check-circle-fill');
            checks.forEach(function (element) {
                element.classList.add('bi-check-circle');
                element.classList.remove('bi-check-circle-fill');
            });
        });

        window.onload = function () {

            fetch('/getUploadedImages')
                .then(response => response.json())
                .then(images => {
                    loadImages(images);
                })
                .catch(error => console.error('Error fetching images:', error));
            loadImages(images);
        }
    </script>

    <div id="controlContainer">
        <h1 style="width:100%">Controls :</h1>
        <br>
        <div id="musicSelection">
            <label for="musicUpload">Add Background Music:</label>
            <select id="backgroundMusic">
                <option value="">Select Background Music</option>
                {% for a in audio %}
                <option value="{{ a['name'] }}"><span class="audioName">{{ a['name'] }}</span></option>
                {% endfor %}
            </select>
            <form id="audioForm" enctype="multipart/form-data">
                <input type="file" id="musicUpload" accept="audio/*" name="audioFile">
                <button type="submit">Upload</button>
            </form>
        </div>
        <div id="durationSetting">
            <label for="imageDuration">Image Duration (seconds):</label>
            <input type="number" id="imageDuration" min="1" value="5">
        </div>
        <div id="transitionEffect">
            <label for="transitionType">Transition Effect:</label>
            <select id="transitionType">
                <option value="fadeIn">Fade In</option>
                <option value="fadeOut">Fade Out</option>
                <option value="fadeInOut">Fade In Out</option>
                <option value="crossFadeIn">Cross Fade In</option>
                <option value="crossFadeOut">Cross Fade Out</option>
                <option value="crossFadeInOut">Cross Fade In Out</option>
            </select>
        </div>
        <div id="outputSettings">
            <label for="resolution">Video Resolution:</label>
            <select id="resolution">
                <option value="360p">360p</option>
                <option value="720p">720p</option>
                <option value="1080p">1080p</option>
                <option value="4k">4k</option>
            </select>
            <label for="quality">Video Quality:</label>
            <select id="quality">
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
            </select>
        </div>
        <div id="buttonContainer">
            <button onclick="generateVideo()">Generate Video</button>
        </div>
    </div>
{% endblock %}